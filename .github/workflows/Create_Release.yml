name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    name: Build and Create Release
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            artifact_name: Linux
          - os: macos-latest
            artifact_name: macOS
          - os: windows-latest
            artifact_name: Windows

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            pkg-config \
            libasound2-dev \
            libjack-jackd2-dev \
            libcurl4-openssl-dev \
            libfreetype6-dev \
            libfontconfig1-dev \
            libx11-dev \
            libxcomposite-dev \
            libxcursor-dev \
            libxext-dev \
            libxinerama-dev \
            libxrandr-dev \
            libxrender-dev \
            libwebkit2gtk-4.1-dev \
            libglu1-mesa-dev \
            mesa-common-dev \
            libgtk-3-dev

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release

      # ===== Linux + macOS: losse .vst3 en standalone =====
      - name: Collect plugin and standalone (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          cd build
          ARTEFACTS=$(ls -d *_artefacts 2>/dev/null | head -1)
          if [ -z "$ARTEFACTS" ]; then
            echo "No *_artefacts directory found"
            exit 1
          fi

          cd "$ARTEFACTS"

          echo "=== Artefacts directory ==="
          pwd
          ls -R

          # Zoek .vst3
          PLUGIN=$(find . -type f -name "*.vst3" | head -1)
          # Zoek standalone: .app op macOS, executable op Linux
          STANDALONE=$(find . -type f \( -name "*.exe" -o -name "*.app" -o -perm -u+x \) | head -1)

          echo "Found plugin: $PLUGIN"
          echo "Found standalone: $STANDALONE"

          mkdir -p ../../release-files

          if [ -n "$PLUGIN" ]; then
            cp "$PLUGIN" "../../release-files/AudioRestoration-${{ matrix.artifact_name }}.vst3"
          fi

          if [ -n "$STANDALONE" ]; then
            # macOS: .app is een directory; Linux: enkel bestand
            if [ -d "$STANDALONE" ]; then
              cp -R "$STANDALONE" "../../release-files/AudioRestoration-${{ matrix.artifact_name }}-Standalone"
            else
              cp "$STANDALONE" "../../release-files/AudioRestoration-${{ matrix.artifact_name }}-Standalone"
            fi
          fi

      - name: Upload Release Assets (Linux/macOS)
        if: matrix.os != 'windows-latest'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/release-files/AudioRestoration-${{ matrix.artifact_name }}.vst3
            build/release-files/AudioRestoration-${{ matrix.artifact_name }}-Standalone/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ===== Windows: losse .vst3 + .exe =====
      - name: Collect plugin and standalone (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          cd build
          $artefacts = Get-ChildItem -Directory -Filter "*_artefacts" | Select-Object -First 1
          if (-not $artefacts) {
            Write-Error "No *_artefacts directory found"
            exit 1
          }

          cd $artefacts.FullName

          Write-Host "=== Artefacts directory ==="
          Get-ChildItem -Recurse

          $plugin = Get-ChildItem -Recurse -Filter *.vst3 | Select-Object -First 1
          $standalone = Get-ChildItem -Recurse -Filter *.exe | Select-Object -First 1

          Write-Host "Found plugin: $($plugin.FullName)"
          Write-Host "Found standalone: $($standalone.FullName)"

          New-Item -ItemType Directory -Path ../../release-files -Force | Out-Null

          if ($plugin) {
            Copy-Item $plugin.FullName ../../release-files/AudioRestoration-Windows.vst3 -Force
          }

          if ($standalone) {
            Copy-Item $standalone.FullName ../../release-files/AudioRestoration-Windows-Standalone.exe -Force
          }

      - name: Upload Release Assets (Windows)
        if: matrix.os == 'windows-latest'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/release-files/AudioRestoration-Windows.vst3
            build/release-files/AudioRestoration-Windows-Standalone.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Docker-publish job laten zoals hij was (optioneel)
  publish-container:
    name: Publish Container Image
    needs: build-and-release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            pkg-config \
            libasound2-dev \
            libjack-jackd2-dev \
            libcurl4-openssl-dev \
            libfreetype6-dev \
            libfontconfig1-dev \
            libx11-dev \
            libxcomposite-dev \
            libxcursor-dev \
            libxext-dev \
            libxinerama-dev \
            libxrandr-dev \
            libxrender-dev \
            libwebkit2gtk-4.1-dev \
            libglu1-mesa-dev \
            mesa-common-dev \
            libgtk-3-dev

      - name: Build
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
