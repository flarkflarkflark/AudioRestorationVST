name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    name: Build and Create Release
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            artifact_name: Linux
          - os: macos-latest
            artifact_name: macOS
          - os: windows-latest
            artifact_name: Windows

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            pkg-config \
            libasound2-dev \
            libjack-jackd2-dev \
            libcurl4-openssl-dev \
            libfreetype6-dev \
            libfontconfig1-dev \
            libx11-dev \
            libxcomposite-dev \
            libxcursor-dev \
            libxext-dev \
            libxinerama-dev \
            libxrandr-dev \
            libxrender-dev \
            libwebkit2gtk-4.1-dev \
            libglu1-mesa-dev \
            mesa-common-dev \
            libgtk-3-dev \
            patchelf

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release

      # ===== Linux + macOS: Collect, Fix, and Zip =====
      - name: Collect and Zip plugin/standalone (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          mkdir -p release-files

          echo "=== Searching for VST3 and Standalone ==="
          PLUGIN=$(find build -name "*.vst3" | head -1)
          if [[ "${{ matrix.os }}" == "macos-latest" ]]; then
            STANDALONE=$(find build -type d -name "*.app" | head -1)
          else
            STANDALONE=$(find build -type f -perm -u+x ! -name "*.so" ! -name "*.dylib" ! -name "cmake*" ! -name "cpack*" ! -name "*.vst3" ! -name "ctest*" ! -name "JUCE*" | grep -i "VinylRestorationSuite" | head -1)
          fi

          # Function to fix shared library dependencies
          fix_deps() {
            local binary="$1"
            local lib_name="$2"
            local lib_pattern="$3"
            
            if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
              # Use -L to follow symlinks and copy the actual file
              local lib_src=$(find build -name "$lib_pattern" | head -1)
              if [ -n "$lib_src" ]; then
                cp -L "$lib_src" "$(dirname "$binary")/"
                # Also copy any versioned variants if they exist
                cp -L $(dirname "$lib_src")/$lib_pattern "$(dirname "$binary")/" 2>/dev/null || true
                patchelf --set-rpath '$ORIGIN' "$binary"
              fi
            elif [[ "${{ matrix.os }}" == "macos-latest" ]]; then
              local lib_src=$(find build -name "$lib_name" | head -1)
              if [ -n "$lib_src" ]; then
                cp "$lib_src" "$(dirname "$binary")/"
                local old_path=$(otool -L "$binary" | grep "$lib_name" | awk '{print $1}')
                if [ -n "$old_path" ]; then
                  install_name_tool -change "$old_path" "@loader_path/$lib_name" "$binary"
                fi
              fi
            fi
          }

          # Process VST3
          if [ -n "$PLUGIN" ]; then
            DEST="release-files/AudioRestoration-${{ matrix.artifact_name }}.vst3"
            cp -R "$PLUGIN" "$DEST"
            INNER_BIN=$(find "$DEST" -type f \( -name "*.so" -o -perm +111 \) ! -name "*.dylib" | head -1)
            if [ -n "$INNER_BIN" ]; then
              fix_deps "$INNER_BIN" "libonnxruntime.dylib" "libonnxruntime.so*"
            fi
            cd release-files && zip -r "AudioRestoration-${{ matrix.artifact_name }}-VST3.zip" "$(basename "$DEST")" && cd ..
          fi

          # Process Standalone
          if [ -n "$STANDALONE" ]; then
            DEST_NAME="AudioRestoration-${{ matrix.artifact_name }}-Standalone"
            if [[ "$STANDALONE" == *.app ]]; then
               DEST_PATH="release-files/$DEST_NAME.app"
               cp -R "$STANDALONE" "$DEST_PATH"
               INNER_BIN=$(find "$DEST_PATH" -type f -perm +111 ! -name "*.dylib" | head -1)
               fix_deps "$INNER_BIN" "libonnxruntime.dylib" "libonnxruntime.so*"
            else
               DEST_PATH="release-files/$DEST_NAME"
               cp "$STANDALONE" "$DEST_PATH"
               fix_deps "$DEST_PATH" "libonnxruntime.dylib" "libonnxruntime.so*"
            fi
            # Ensure we include the .so files in the root of the ZIP for Linux standalone
            cd release-files
            if [[ "${{ matrix.os }}" == "ubuntu-latest" && "$STANDALONE" != *.app ]]; then
               zip -r "AudioRestoration-${{ matrix.artifact_name }}-Standalone.zip" "$(basename "$DEST_PATH")" libonnxruntime.so*
            else
               zip -r "AudioRestoration-${{ matrix.artifact_name }}-Standalone.zip" "$(basename "$DEST_PATH")"
            fi
            cd ..
          fi

      - name: Upload Release Assets (Linux/macOS)
        if: matrix.os != 'windows-latest'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release-files/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ===== Windows: Collect and Zip =====
      - name: Collect and Zip plugin/standalone (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path release-files -Force | Out-Null
          
          Write-Host "=== Searching for VST3 and Standalone ==="
          $plugin = Get-ChildItem -Recurse build -Include *.vst3 | Select-Object -First 1
          $standalone = Get-ChildItem -Recurse build -Include *.exe | Where-Object { $_.Name -like "*VinylRestorationSuite*" -and $_.Name -notlike "*cmake*" -and $_.Name -notlike "*vst3*" } | Select-Object -First 1

          Write-Host "Found plugin: $($plugin.FullName)"
          Write-Host "Found standalone: $($standalone.FullName)"
          
          # Copy and Zip VST3
          if ($plugin) {
            $destVst = "release-files/AudioRestoration-Windows.vst3"
            Copy-Item $plugin.FullName -Destination $destVst -Recurse -Force
            $zipPath = "release-files/AudioRestoration-Windows-VST3.zip"
            Compress-Archive -Path $destVst -DestinationPath $zipPath -Force
          }

          # Copy and Zip Standalone
          if ($standalone) {
            $destDir = New-Item -ItemType Directory -Path "release-files/AudioRestoration-Windows-Standalone" -Force
            Copy-Item $standalone.FullName -Destination $destDir.FullName -Force
            $standaloneDir = Split-Path $standalone.FullName
            Get-ChildItem -Path $standaloneDir -Filter *.dll | Copy-Item -Destination $destDir.FullName -Force
            $zipPath = "release-files/AudioRestoration-Windows-Standalone.zip"
            Compress-Archive -Path $destDir.FullName -DestinationPath $zipPath -Force
          }

      - name: Upload Release Assets (Windows)
        if: matrix.os == 'windows-latest'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release-files/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-container:
    name: Publish Container Image
    needs: build-and-release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            pkg-config \
            libasound2-dev \
            libjack-jackd2-dev \
            libcurl4-openssl-dev \
            libfreetype6-dev \
            libfontconfig1-dev \
            libx11-dev \
            libxcomposite-dev \
            libxcursor-dev \
            libxext-dev \
            libxinerama-dev \
            libxrandr-dev \
            libxrender-dev \
            libwebkit2gtk-4.1-dev \
            libglu1-mesa-dev \
            mesa-common-dev \
            libgtk-3-dev

      - name: Build
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
